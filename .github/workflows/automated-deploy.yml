name: ğŸš€ Automated Deploy & Migrations

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Job 1: Executar migraÃ§Ãµes no Supabase
  migrate:
    name: ğŸ—„ï¸ Supabase Migrations
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”— Link to Supabase project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}

      - name: ğŸš€ Run migrations
        run: |
          supabase db push --include-all
        env:
          SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ env.SUPABASE_DB_PASSWORD }}

  # Job 2: Build e Deploy no Vercel
  deploy:
    name: ğŸŒ Vercel Deploy
    runs-on: ubuntu-latest
    needs: migrate
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_APP_BASE_URL: https://www.appvidasmart.com
          VITE_APP_ENV: production

      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ env.VERCEL_TOKEN }}
          vercel-org-id: ${{ env.VERCEL_ORG_ID }}
          vercel-project-id: ${{ env.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

  # Job 3: Verificar saÃºde do sistema
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: ğŸ” Check website health
        run: |
          echo "Verificando saÃºde do site..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://www.appvidasmart.com)
          if [ $response -eq 200 ]; then
            echo "âœ… Site estÃ¡ funcionando corretamente!"
          else
            echo "âŒ Site retornou cÃ³digo: $response"
            exit 1
          fi

      - name: ğŸ—„ï¸ Check Supabase connection
        run: |
          echo "Verificando conexÃ£o com Supabase..."
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "apikey: ${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            "${{ secrets.VITE_SUPABASE_URL }}/rest/v1/")
          if [ $response -eq 200 ]; then
            echo "âœ… Supabase estÃ¡ funcionando corretamente!"
          else
            echo "âŒ Supabase retornou cÃ³digo: $response"
            exit 1
          fi

  # Job 4: NotificaÃ§Ã£o de sucesso
  notify:
    name: ğŸ“¢ Success Notification
    runs-on: ubuntu-latest
    needs: [migrate, deploy, health-check]
    if: success()
    steps:
      - name: ğŸ‰ Deploy Success
        run: |
          echo "ğŸ‰ Deploy automatizado concluÃ­do com sucesso!"
          echo "âœ… MigraÃ§Ãµes aplicadas no Supabase"
          echo "âœ… AplicaÃ§Ã£o deployada no Vercel"
          echo "âœ… Health checks passaram"
          echo "ğŸŒ Site disponÃ­vel em: https://www.appvidasmart.com"

