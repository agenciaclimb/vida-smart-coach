#!/usr/bin/env sh
# Pre-commit hook - HOTFIX PROTOCOL 1.0
# Executado automaticamente antes de cada commit
# Configurar com: pnpm setup:githooks

set -e

echo ""
echo "ğŸ” HOTFIX PROTOCOL 1.0 - ValidaÃ§Ã£o PrÃ©-Commit"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# 1. Lint Check
echo "1ï¸âƒ£ ESLint (max-warnings 0)..."
pnpm lint
if [ $? -ne 0 ]; then
  echo "âŒ ERRO: ESLint falhou. Corrija os erros antes do commit."
  exit 1
fi
echo "   âœ… Lint OK"
echo ""

# 2. TypeScript Check
echo "2ï¸âƒ£ TypeScript (typecheck)..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ ERRO: TypeScript falhou. Corrija os tipos antes do commit."
  exit 1
fi
echo "   âœ… TypeScript OK"
echo ""

# 3. Unit Tests (apenas arquivos modificados se possÃ­vel)
echo "3ï¸âƒ£ Testes unitÃ¡rios..."
pnpm test
if [ $? -ne 0 ]; then
  echo "âŒ ERRO: Testes falharam. Corrija antes do commit."
  exit 1
fi
echo "   âœ… Testes OK"
echo ""

# 4. Secret Scan
echo "4ï¸âƒ£ Secret scan..."
node tools/secret-scan.js
if [ $? -ne 0 ]; then
  echo "âŒ ERRO: Secrets detectados. Remova antes do commit."
  exit 1
fi
echo "   âœ… Sem secrets detectados"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… TODAS AS VALIDAÃ‡Ã•ES PASSARAM!"
echo "âœ… Commit permitido pelo HOTFIX PROTOCOL 1.0"
echo ""

exit 0
