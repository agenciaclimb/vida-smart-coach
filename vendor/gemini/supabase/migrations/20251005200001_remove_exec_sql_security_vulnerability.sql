-- Remove critical security vulnerability: exec_sql function
-- This function allowed any authenticated user to execute arbitrary SQL with elevated privileges
-- 
-- Security issues:
-- 1. SECURITY DEFINER runs with database owner privileges
-- 2. Granted to 'authenticated' role (all logged-in users)
-- 3. No input validation or access controls
-- 4. Can bypass all Row Level Security policies
-- 5. Violates Supabase security best practices

-- Drop the dangerous function
DROP FUNCTION IF EXISTS public.exec_sql(text);

-- Log the security fix
INSERT INTO public.migration_logs (migration_name, executed_at, description) 
VALUES (
   '20251005200001_remove_exec_sql_security_vulnerability',
   NOW(),
   'SECURITY FIX: Removed exec_sql function that allowed arbitrary SQL execution with elevated privileges'
) ON CONFLICT DO NOTHING;

-- Add comment for audit trail
COMMENT ON SCHEMA public IS 'exec_sql function removed 2025-10-05 for security - function allowed arbitrary SQL execution';